# SFTP via EICE tunnel tests

# Create local test file for EICE SFTP
exec sh -c 'echo "eice-sftp-content-$(date +%s)" > $WORK/eice-sftp-upload.txt'

# Create SFTP batch file
exec sh -c 'echo "put $WORK/eice-sftp-upload.txt /tmp/e2e-eice-sftp.txt" > $WORK/eice-sftp-batch.txt'
exec sh -c 'echo "quit" >> $WORK/eice-sftp-batch.txt'

# Upload via EICE SFTP
exec ec2ssh --sftp --eice-id $EICE_ID -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -b $WORK/eice-sftp-batch.txt $USER@$PRIVATE_ID

# Verify SFTP upload
exec ec2ssh --eice-id $EICE_ID -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $USER@$PRIVATE_ID -- cat /tmp/e2e-eice-sftp.txt
stdout 'eice-sftp-content'

# Test EICE auto-detection: --use-eice WITHOUT --eice-id
exec sh -c 'echo "eice-auto-sftp-$(date +%s)" > $WORK/eice-auto-sftp.txt'
exec sh -c 'echo "put $WORK/eice-auto-sftp.txt /tmp/e2e-eice-auto-sftp.txt" > $WORK/eice-auto-batch.txt'
exec sh -c 'echo "quit" >> $WORK/eice-auto-batch.txt'

# Upload via EICE auto-detect SFTP
exec ec2ssh --sftp --use-eice -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -b $WORK/eice-auto-batch.txt $USER@$PRIVATE_ID

# Verify auto-detect SFTP upload
exec ec2ssh --use-eice -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $USER@$PRIVATE_ID -- cat /tmp/e2e-eice-auto-sftp.txt
stdout 'eice-auto-sftp'
